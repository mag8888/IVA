# Генерация тестового дерева структуры

## Описание

API endpoint `/api/structure/generate/` позволяет создать тестовое MLM-дерево для визуализации без необходимости запуска команд через терминал Railway.

## Использование

### Вариант 1: Через браузер (GET запрос)

Откройте в браузере следующий URL:

```
https://iva-production-4400.up.railway.app/api/structure/generate/?children=6
```

**Параметры:**
- `children` (опционально) - количество тестовых партнеров для создания (по умолчанию 6)
- `root_username` (опционально) - имя пользователя, который станет корнем дерева (по умолчанию первый суперпользователь)

**Примеры:**
- `https://iva-production-4400.up.railway.app/api/structure/generate/` - создаст дерево с 6 партнерами
- `https://iva-production-4400.up.railway.app/api/structure/generate/?children=10` - создаст дерево с 10 партнерами
- `https://iva-production-4400.up.railway.app/api/structure/generate/?root_username=roman&children=6` - создаст дерево с корнем `roman` и 6 партнерами

### Вариант 2: Через POST запрос (curl)

```bash
curl -X POST https://iva-production-4400.up.railway.app/api/structure/generate/ \
  -H "Content-Type: application/json" \
  -d '{"children": 6, "root_username": "roman"}'
```

### Вариант 3: Через Postman или другой HTTP клиент

1. Метод: `GET` или `POST`
2. URL: `https://iva-production-4400.up.railway.app/api/structure/generate/`
3. Для GET: добавьте параметры в query string (`?children=6`)
4. Для POST: отправьте JSON в body:
   ```json
   {
     "children": 6,
     "root_username": "roman"
   }
   ```

## Ответ API

При успешном выполнении API вернет JSON:

```json
{
  "success": true,
  "message": "Тестовое дерево структуры успешно создано",
  "root_user": {
    "id": 1,
    "username": "roman",
    "referral_code": "ABC12345"
  },
  "created_partners": [
    "demo_partner_1_abc123",
    "demo_partner_2_def456",
    ...
  ],
  "total_nodes": 7,
  "structure": {
    "user": {
      "id": 1,
      "username": "roman",
      "referral_code": "ABC12345"
    },
    "level": 0,
    "position": 1,
    "tariff": {
      "code": "basic",
      "name": "Basic"
    },
    "children": [
      ...
    ]
  }
}
```

## Что делает endpoint

1. **Создает или получает корневого пользователя:**
   - Если указан `root_username`, создает или получает пользователя с этим именем
   - Если не указан, использует первого суперпользователя
   - Если суперпользователей нет, создает нового `root_admin`

2. **Создает или получает тариф:**
   - Создает тариф `basic` с суммой вступления $100
   - Зеленый бонус: 50%
   - Желтый бонус: 50%

3. **Создает корневой узел структуры:**
   - Если корневой узел еще не существует, создает его
   - Устанавливает статус пользователя на `PARTNER`

4. **Создает тестовых партнеров:**
   - Генерирует указанное количество партнеров (по умолчанию 6)
   - Создает платежи со статусом `COMPLETED`
   - Размещает партнеров в структуре через `place_user()`
   - Начисляет бонусы через `apply_signup_bonuses()`

## После генерации

После успешной генерации структуры:

1. **Проверьте структуру:**
   - Откройте `/api/structure/tree/` - должно вернуть дерево структуры
   - Откройте `/api/structure/` - должно вернуть список всех узлов

2. **Проверьте мини-приложение Telegram:**
   - Откройте `/app` в Telegram боте
   - Структура должна отображаться без ошибок

3. **Проверьте статистику:**
   - Откройте `/api/stats/` - должно показать количество узлов, партнеров и бонусов

## Безопасность

⚠️ **Важно:** Этот endpoint доступен без аутентификации (`AllowAny`). В production рекомендуется:

1. Добавить аутентификацию
2. Добавить проверку на количество создаваемых партнеров (максимум)
3. Добавить rate limiting
4. Ограничить доступ только для администраторов

## Устранение проблем

### Ошибка: "Структура пуста"

Это означает, что корневой узел не был создан. Попробуйте:
1. Указать `root_username` явно
2. Убедиться, что в базе есть суперпользователь
3. Проверить логи Railway на наличие ошибок

### Ошибка: "Пользователь уже размещен в структуре"

Это означает, что пользователь уже имеет `StructureNode`. Это нормально - endpoint пропустит таких пользователей и создаст только новых.

### Ошибка: "Платеж должен быть завершен перед размещением"

Это не должно происходить, так как endpoint создает платежи со статусом `COMPLETED`. Если ошибка все же возникает, проверьте логи Railway.

## Логи

После вызова endpoint проверьте логи Railway:
- Откройте проект `backend-django` → сервис `IVA` → вкладка `Deploy Logs` или `HTTP Logs`
- Найдите записи с URL `/api/structure/generate/`
- Проверьте наличие ошибок в ответе

