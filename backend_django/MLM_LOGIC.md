# Логика размещения пользователей в MLM структуре

## Как я понимаю логику

### 1. Трехуровневая структура (TRINARY MLM)

**Принцип**: Каждый партнер может иметь максимум 3 партнера на своем уровне.

```
        Root (Level 0)
         /  |  \
        /   |   \
    User1 User2 User3 (Level 1)
    /|\   /|\   /|\
   ...   ...   ... (Level 2)
```

- **Максимум партнеров на уровень**: 3 (настраивается через `MAX_PARTNERS_PER_LEVEL`)
- **Позиции**: 1, 2, 3 (у каждого родителя)
- **Уровни**: 0 (корень), 1, 2, 3... (увеличивается вниз)

### 2. Процесс регистрации и размещения

#### Этап 1: Регистрация участника
1. Пользователь регистрируется через API `/api/register/`
2. Указывает `referral_code` пригласившего
3. Создается пользователь со статусом `PARTICIPANT`
4. Создается платеж (Payment) со статусом `PENDING`
5. Пользователь получает временный пароль

#### Этап 2: Очередь регистраций
- Администратор видит очередь через `/api/queue/`
- В очереди все пользователи с `status=PENDING`

#### Этап 3: Завершение регистрации
1. Администратор подтверждает оплату через `/api/complete/`
2. Платеж переводится в статус `COMPLETED`
3. Статус пользователя меняется на `PARTNER`
4. **Пользователь размещается в структуре** через `place_user()`
5. **Начисляются бонусы** через `apply_signup_bonuses()`

### 3. Алгоритм размещения (BFS - Breadth-First Search)

**Цель**: Найти первого пользователя с менее чем 3 партнерами и разместить нового пользователя.

**Шаги**:
1. Начинаем с корня структуры (root user)
2. Используем BFS (обход в ширину) - сначала все на уровне 0, потом уровень 1, и т.д.
3. Для каждого пользователя проверяем:
   - Есть ли у него менее 3 партнеров?
   - Если да → размещаем нового пользователя в свободную позицию
   - Если нет → переходим к следующему пользователю
4. Позиция выбирается: первая свободная (1, 2 или 3)
5. Уровень нового пользователя = `parent.level + 1`

**Пример**:
```
Корень (Level 0) - 0 партнеров → размещаем здесь (Position 1, Level 1)
Если корень заполнен (3 партнера), идем к первому партнеру Level 1
Партнер Level 1 - 2 партнера → размещаем здесь (Position 3, Level 2)
И так далее...
```

### 4. Система бонусов

#### Green Bonus (Зеленый бонус / Payout Bonus)
- **Получатель**: Пригласивший (inviter) - тот, кто дал referral_code
- **Условие**: При регистрации нового партнера
- **Размер**: `entry_amount * green_bonus_percent / 100`
- **Пример**: Тариф $100, 50% = $50

#### Yellow Bonus (Желтый бонус / Transition Bonus)
- **Получатель**: Владелец позиции размещения (parent) - тот, под кого разместили
- **Условие**: При размещении нового партнера в структуре
- **Размер**: `entry_amount * yellow_bonus_percent / 100`
- **Пример**: Тариф $100, 50% = $50

**Важно**: 
- Green Bonus получает **inviter** (кто пригласил)
- Yellow Bonus получает **parent** (под кого разместили)
- Это могут быть **разные люди**!

### 5. Пример полного процесса

**Сценарий**:
1. User A регистрируется (корень)
2. User B регистрируется с referral_code от User A
3. User C регистрируется с referral_code от User A

**Размещение**:
```
User A (Level 0, корень)
├── User B (Level 1, Position 1) - приглашен User A
└── User C (Level 1, Position 2) - приглашен User A
```

**Бонусы для User B**:
- Green Bonus: User A получает (пригласил User B)
- Yellow Bonus: User A получает (разместил User B под собой)

**Бонусы для User C**:
- Green Bonus: User A получает (пригласил User C)
- Yellow Bonus: User A получает (разместил User C под собой)

**Сценарий 2**: User D регистрируется с referral_code от User B
- User B уже имеет 0 партнеров → размещаем User D под User B
- Green Bonus: User B получает (пригласил User D)
- Yellow Bonus: User B получает (разместил User D под собой)

### 6. Особые случаи

#### Корневой пользователь
- Первый пользователь в системе становится корнем (Level 0)
- У корня нет parent
- Корень может иметь до 3 партнеров

#### Если структура заполнена
- BFS продолжает поиск до тех пор, пока не найдет свободное место
- В теории структура может быть бесконечной (на практике ограничена)

#### Если inviter не найден
- Если referral_code неверный → ошибка при регистрации
- Или можно разместить в корень (если разрешено)

## Реализация

### Функции для реализации:

1. `find_parent_for_new_partner(user)` - найти родителя для размещения (BFS)
2. `place_user(user, parent, position)` - разместить пользователя в структуре
3. `apply_signup_bonuses(user, payment)` - начислить бонусы
4. `calculate_bonus_amounts(tariff)` - рассчитать суммы бонусов

### Структура данных:

```python
StructureNode:
- user: новый пользователь
- parent: найденный родитель (через BFS)
- position: свободная позиция (1, 2 или 3)
- level: parent.level + 1
- tariff: тариф из payment
```

## Вопросы для уточнения

1. **Корневой пользователь**: Как создается? Первый в системе автоматически?
2. **Если inviter не найден**: Размещать в корень или ошибка?
3. **Балансировка**: Нужно ли балансировать позиции (1, 2, 3) или просто первая свободная?
4. **Уровни**: Есть ли максимальный уровень или бесконечно?

