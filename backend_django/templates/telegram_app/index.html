<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Equilibrium MLM - –ú–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 24px;
            color: var(--tg-theme-button-color, #3390ec);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .structure-container {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
            padding: 15px;
            min-height: 300px;
        }

        .node {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 8px 0;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .node.root {
            background: var(--tg-theme-button-color, #3390ec);
            font-weight: bold;
        }

        .node.level-1 {
            background: #28a745;
            margin-left: 20px;
        }

        .node.level-2 {
            background: #ffc107;
            margin-left: 40px;
        }

        .node.level-3 {
            background: #dc3545;
            margin-left: 60px;
        }

        .node-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 12px;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 50px 20px;
        }

        .loading .spinner {
            border: 3px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 3px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .empty {
            text-align: center;
            padding: 50px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ –ú–æ—è MLM –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h1>
            <p id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3 id="total-partners">-</h3>
                <p>–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤</p>
            </div>
            <div class="stat-card">
                <h3 id="total-bonuses">-</h3>
                <p>–ë–æ–Ω—É—Å–æ–≤</p>
            </div>
            <div class="stat-card">
                <h3 id="green-bonuses">-</h3>
                <p>–ó–µ–ª–µ–Ω—ã—Ö</p>
            </div>
            <div class="stat-card">
                <h3 id="yellow-bonuses">-</h3>
                <p>–ñ–µ–ª—Ç—ã—Ö</p>
            </div>
        </div>

        <div class="structure-container">
            <div id="structure-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...</p>
                </div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadData()" title="–û–±–Ω–æ–≤–∏—Ç—å">
        üîÑ
    </button>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // API URL (–±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω)
        const API_URL = window.location.origin.replace(/\/$/, '');

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const tgUser = tg.initDataUnsafe?.user;
        const userId = tgUser?.id;
        const telegramUsername = tgUser?.username;
        
        console.log('Telegram User:', tgUser);
        console.log('User ID:', userId);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        if (tgUser) {
            document.getElementById('user-info').textContent = 
                `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || tgUser.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            const structureContent = document.getElementById('structure-content');
            structureContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É–∑–ª–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const structureListResponse = await fetch(`${API_URL}/api/structure/`);
                if (!structureListResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã');
                }
                const structureList = await structureListResponse.json();
                
                // –ù–∞—Ö–æ–¥–∏–º —É–∑–µ–ª —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID –∏–ª–∏ username
                let userNode = null;
                if (userId || telegramUsername) {
                    userNode = structureList.find(node => {
                        const nodeUsername = node.user?.username;
                        // –ò—â–µ–º –ø–æ Telegram ID (–µ—Å–ª–∏ username = Telegram ID) –∏–ª–∏ –ø–æ username
                        return nodeUsername === String(userId) || nodeUsername === telegramUsername;
                    });
                }
                
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —É–∑–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ –æ—Ç –Ω–µ–≥–æ
                // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
                let rootUserId = null;
                if (userNode) {
                    rootUserId = userNode.user.id;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const treeUrl = rootUserId 
                    ? `${API_URL}/api/structure/tree/?root_user_id=${rootUserId}`
                    : `${API_URL}/api/structure/tree/`;
                
                const structureResponse = await fetch(treeUrl);
                if (!structureResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã');
                }
                const structure = await structureResponse.json();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ–Ω—É—Å–æ–≤
                let bonuses = { total: 0, green: 0, yellow: 0 };
                
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –ø–æ Telegram ID –∏–ª–∏ username
                if (userNode && userNode.user.id) {
                    try {
                        const bonusesResponse = await fetch(`${API_URL}/api/bonuses/?user_id=${userNode.user.id}`);
                        if (bonusesResponse.ok) {
                            const bonusesList = await bonusesResponse.json();
                            bonuses.total = bonusesList.reduce((sum, b) => sum + parseFloat(b.amount), 0);
                            bonuses.green = bonusesList
                                .filter(b => b.bonus_type === 'GREEN')
                                .reduce((sum, b) => sum + parseFloat(b.amount), 0);
                            bonuses.yellow = bonusesList
                                .filter(b => b.bonus_type === 'YELLOW')
                                .reduce((sum, b) => sum + parseFloat(b.amount), 0);
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–Ω—É—Å–æ–≤:', e);
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats(structure, bonuses);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                renderStructure(structure);

            } catch (error) {
                structureContent.innerHTML = `
                    <div class="error">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}
                    </div>
                `;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(structure, bonuses) {
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
            function countPartners(node) {
                let count = 0;
                if (node.children && node.children.length > 0) {
                    count = node.children.length;
                    node.children.forEach(child => {
                        count += countPartners(child);
                    });
                }
                return count;
            }

            const totalPartners = structure ? countPartners(structure) : 0;

            document.getElementById('total-partners').textContent = totalPartners;
            document.getElementById('total-bonuses').textContent = `$${bonuses.total.toFixed(2)}`;
            document.getElementById('green-bonuses').textContent = `$${bonuses.green.toFixed(2)}`;
            document.getElementById('yellow-bonuses').textContent = `$${bonuses.yellow.toFixed(2)}`;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        function renderStructure(node, level = 0) {
            if (!node) {
                document.getElementById('structure-content').innerHTML = 
                    '<div class="empty">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—É—Å—Ç–∞</div>';
                return;
            }

            const container = document.getElementById('structure-content');
            container.innerHTML = '';

            function renderNode(n, lvl) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = `node ${lvl === 0 ? 'root' : ''} level-${Math.min(lvl, 3)}`;

                const userName = n.user?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const level = n.level || lvl;
                const position = n.position || '';
                const tariff = n.tariff?.name || '';

                nodeDiv.innerHTML = `
                    <div><strong>${userName}</strong></div>
                    <div class="node-info">
                        <span>Level ${level}</span>
                        ${position ? `<span>Pos ${position}</span>` : ''}
                        ${tariff ? `<span>${tariff}</span>` : ''}
                    </div>
                `;

                container.appendChild(nodeDiv);

                // –†–µ–Ω–¥–µ—Ä–∏–º –¥–µ—Ç–µ–π
                if (n.children && n.children.length > 0) {
                    n.children.forEach(child => {
                        renderNode(child, lvl + 1);
                    });
                }
            }

            renderNode(node, level);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadData();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.onClick(() => {
            tg.close();
        });
    </script>
</body>
</html>

